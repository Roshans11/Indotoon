<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Indotoon - Home</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js"></script>
  <style>
    body {
  font-family: 'Segoe UI', sans-serif;
  background: linear-gradient(to right, #0f2027, #203a43, #2c5364);
  color: #e0e0e0;
  margin: 0;
  padding: 0;
}

header {
  background: #1b2735;
  padding: 1rem 2rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 4px 10px rgba(0,0,0,0.5);
}

header h1 {
  margin: 0;
  color: #ff4b5c;
  font-size: 1.8rem;
}

#welcomeMsg {
  font-size: 1rem;
  color: #f0f0f0;
}

button {
  background: #ff4b5c;
  color: white;
  border: none;
  padding: 0.6rem 1.2rem;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
  transition: background 0.3s, transform 0.2s;
}

button:hover {
  background: #ff6b7c;
  transform: scale(1.05);
}

#uploadSection {
  background: #283e51;
  padding: 1rem;
  border-radius: 10px;
  margin-bottom: 1rem;
}

#uploadSection input {
  padding: 0.5rem;
  margin: 0.5rem 0;
  border-radius: 5px;
  border: none;
  width: calc(50% - 1rem);
}

#searchBarContainer {
  margin: 1rem 0;
  display: flex;
  justify-content: center;
  gap: 0.5rem;
}

#searchBarContainer input {
  padding: 0.5rem;
  width: 60%;
  border-radius: 5px;
  border: none;
}

#searchBtn {
  background: #ff4b5c;
  font-size: 1.2rem;
}

.episodes-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1.5rem;
}

.episode-box {
  background: #1b2735;
  padding: 1rem;
  border-radius: 10px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.3);
  transition: transform 0.3s, box-shadow 0.3s;
}

.episode-box:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 16px rgba(0,0,0,0.5);
}

.episode-box h3 {
  font-size: 1.1rem;
  color: #ff4b5c;
}

.episode-box video {
  width: 100%;
  border-radius: 10px;
}

.actions {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-top: 0.5rem;
}

.comment-box input {
  width: 100%;
  padding: 0.5rem;
  border-radius: 5px;
  border: none;
  margin-bottom: 0.25rem;
}

.comment-box button {
  width: 100%;
}

.comments-list {
  background: rgba(255,255,255,0.05);
  padding: 0.5rem;
  border-radius: 5px;
  max-height: 100px;
  overflow-y: auto;
}

.comments-list div {
  margin-bottom: 0.25rem;
}

@media (max-width: 600px) {
  #uploadSection input {
    width: 100%;
  }
  #searchBarContainer input {
    width: 100%;
  }
}
/* General body adjustments for smaller screens */
body {
  font-size: 16px; /* slightly larger base text for readability */
}

/* Make header elements stack or shrink on small devices */
header {
  flex-wrap: wrap;
  gap: 0.5rem;
}

header h1 {
  font-size: 1.5rem;
}

#welcomeMsg {
  width: 100%;
  text-align: center;
  margin-top: 0.5rem;
}

/* Upload section inputs full width on mobile */
#uploadSection input {
  width: 100%;
}

/* Search bar adapts */
#searchBarContainer {
  flex-direction: column;
  align-items: stretch;
  padding: 0 0.5rem;
}

#searchBarContainer input {
  width: 100%;
}

#searchBtn {
  width: 100%;
}

/* Make buttons take full width where useful on mobile */
button {
  width: auto; /* default to auto, but specific buttons can be full width if needed */
}

@media (max-width: 600px) {
  header {
    flex-direction: column;
    align-items: center;
  }

  button {
    width: 100%;
    padding: 0.75rem;
  }

  .episodes-grid {
    grid-template-columns: 1fr;
  }

  .episode-box {
    padding: 0.5rem;
  }

  .episode-box h3 {
    font-size: 1rem;
  }

  .actions {
    flex-direction: column;
    gap: 0.25rem;
  }

  .comment-box input,
  .comment-box button {
    width: 100%;
  }
}
  @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap');

  body {
    font-family: 'Nunito', sans-serif;
    background: linear-gradient(to right, #1f1c2c, #928dab);
    color: #ffffff;
    margin: 0;
    padding: 0;
  }

  header {
    background: #0f3460;
    padding: 1rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }

  header h1 {
    margin: 0;
    color: #e94560;
    font-size: 1.8rem;
  }

  #welcomeMsg {
    font-size: 1rem;
    color: #f0f0f0;
  }

  button {
    background: #e94560;
    color: white;
    border: none;
    padding: 0.6rem 1.2rem;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    transition: background 0.3s, transform 0.2s;
  }

  button:hover {
    background: #ff2e4c;
    transform: scale(1.05);
  }

  main {
    padding: 1rem;
    max-width: 1200px;
    margin: auto;
  }

  #uploadSection {
    background: #1f4068;
    padding: 1rem;
    border-radius: 10px;
    margin-bottom: 1.5rem;
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
  }

  #uploadSection h2 {
    color: #ffd6dd;
    font-size: 1.3rem;
  }

  #uploadSection input {
    padding: 0.6rem;
    margin: 0.5rem 0;
    border-radius: 6px;
    border: none;
    width: 100%;
    font-size: 1rem;
  }

  #searchBarContainer {
    margin-bottom: 1.5rem;
    display: flex;
    flex-direction: row;
    gap: 0.5rem;
    justify-content: center;
  }

  #searchBarContainer input {
    padding: 0.6rem;
    width: 60%;
    border-radius: 6px;
    border: none;
    font-size: 1rem;
  }

  #searchBtn {
    font-size: 1.2rem;
    padding: 0.6rem 1.2rem;
  }

  .episodes-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
  }

  .episode-box {
    background: #1a1a40;
    padding: 1rem;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .episode-box:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.5);
  }

  .episode-box h3 {
    color: #ff7b9c;
    font-size: 1.2rem;
    margin-bottom: 0.5rem;
  }

  .episode-box video {
    width: 100%;
    border-radius: 8px;
    margin-bottom: 0.5rem;
  }

  .actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin: 0.5rem 0;
  }

  .comment-box input {
    width: 100%;
    padding: 0.5rem;
    border-radius: 6px;
    border: none;
    margin-bottom: 0.25rem;
    font-size: 0.95rem;
  }

  .comment-box button {
    width: 100%;
    font-size: 0.95rem;
  }

  .comments-list {
    background: rgba(255, 255, 255, 0.07);
    padding: 0.5rem;
    border-radius: 6px;
    max-height: 100px;
    overflow-y: auto;
    font-size: 0.9rem;
  }

  .comments-list div {
    margin-bottom: 0.25rem;
  }

  @media (max-width: 768px) {
    header {
      flex-direction: column;
      gap: 0.5rem;
    }

    #searchBarContainer {
      flex-direction: column;
      align-items: stretch;
    }

    .auth-buttons,
    .actions {
      flex-direction: column;
    }

    .episodes-grid {
      grid-template-columns: 1fr;
    }

    .episode-box h3 {
      font-size: 1rem;
    }
  }




    body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(to right, #1a1a2e, #16213e); color: white; margin: 0; padding: 0; }
    header { background: #0f3460; padding: 1rem; display: flex; justify-content: space-between; align-items: center; }
    header h1 { margin: 0; color: #e94560; }
    #welcomeMsg { font-size: 1rem; }
    button { background: #e94560; color: white; border: none; padding: 0.5rem 1rem; cursor: pointer; border-radius: 8px; }
    main { padding: 1rem; }
    #uploadSection { background: #1f4068; padding: 1rem; border-radius: 10px; margin-bottom: 1rem; }
    .episodes-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; }
    .episode-box { background: #1f4068; padding: 1rem; border-radius: 10px; transition: 0.3s; }
    .episode-box:hover { transform: scale(1.02); background: #324a7d; }
    .episode-box video { width: 100%; border-radius: 10px; }
    .actions { margin-top: 0.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .comment-box { margin-top: 0.5rem; }
    .comment-box input { width: 100%; padding: 0.5rem; border-radius: 5px; border: none; margin-bottom: 0.25rem; }
    .comments-list { font-size: 0.85rem; max-height: 100px; overflow-y: auto; }
  </style>
</head>
<body>
  <header>
    <h1>Indotoon</h1>
    <div id="welcomeMsg"></div>
    <button onclick="logout()">Logout</button>
  </header>

  <main id="mainContent">
    <section id="uploadSection" style="display:none">
      <h2>Upload New Episode (Paste Video URL)</h2>
      <input type="text" id="title" placeholder="Episode Title">
      <input type="url" id="videoURL" placeholder="Cloudinary Video URL">
      <button onclick="uploadEpisode()">Submit</button>
      <p id="uploadMsg"></p>
    </section>

    <div id="searchBarContainer">
      <input type="text" id="searchInput" placeholder="Search episodes by title..." />
      <button id="searchBtn" onclick="filterEpisodes()">üîç</button>
    </div>

    <section id="episodesContainer" class="episodes-grid"></section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, getDoc, doc, deleteDoc, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAI3Y4Jbjo013rxoEekaDIQFdPNVjX66eE",
      authDomain: "indotoon1.firebaseapp.com",
      projectId: "indotoon1",
      storageBucket: "indotoon1.appspot.com",
      messagingSenderId: "123244904427",
      appId: "1:123244904427:web:46390fbb109d033ab1a3ae",
      measurementId: "G-59N6G3QD68"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let userEmail = "";
    let username = "";
    let firstName = "";
    let isOwner = false;

    let allEpisodes = [];

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        location.href = "index.html";
        return;
      }
      userEmail = user.email;

      // Get user info
      const userDoc = await getDoc(doc(db, "users", user.uid));
      if (userDoc.exists()) {
        const data = userDoc.data();
        username = data.username || "";
        firstName = data.firstName || "";
        document.getElementById("welcomeMsg").textContent = `Welcome, ${firstName}!`;
      }

      const role = user.displayName || localStorage.getItem("userRole");
      if (role === "owner") {
        isOwner = true;
        document.getElementById("uploadSection").style.display = "block";
      }

      fetchAndRenderEpisodes();
    });

    async function fetchAndRenderEpisodes() {
      const querySnapshot = await getDocs(collection(db, "episodes"));
      allEpisodes = [];
      querySnapshot.forEach((docSnap) => {
        const data = docSnap.data();
        data.id = docSnap.id;
        allEpisodes.push(data);
      });
      renderEpisodes(allEpisodes);
    }
    window.filterEpisodes = () => {
  const query = document.getElementById("searchInput").value.toLowerCase().trim();
  if (!query) {
    renderEpisodes(allEpisodes); // if no input, show all
    return;
  }

  const matched = allEpisodes.filter(ep => ep.title.toLowerCase().includes(query));
  const unmatched = allEpisodes.filter(ep => !ep.title.toLowerCase().includes(query));

  renderEpisodes([...matched, ...unmatched]); // matched videos first
};

    window.uploadEpisode = async () => {
      const title = document.getElementById("title").value;
      const url = document.getElementById("videoURL").value;
      if (!url || !title) return alert("Please enter a title and a video URL");
      await addDoc(collection(db, "episodes"), { title, url, likes: 0, comments: [], likedUsers: [] });
      document.getElementById("uploadMsg").textContent = "Uploaded!";
      fetchAndRenderEpisodes();
    };

    window.addComment = async (id) => {
      const input = document.getElementById(`comment-${id}`);
      const text = input.value.trim();
      if (!text) return;
      const commentObj = { username: username, text: text };
      const episodeRef = doc(db, "episodes", id);
      await updateDoc(episodeRef, { comments: arrayUnion(commentObj) });
      input.value = "";
      fetchAndRenderEpisodes();
    };

    window.toggleLike = async (id) => {
      const episodeRef = doc(db, "episodes", id);
      const docSnap = await getDoc(episodeRef);
      const data = docSnap.data();
      let newLikes = data.likes || 0;
      if ((data.likedUsers || []).includes(userEmail)) {
        newLikes = Math.max(0, newLikes - 1);
        await updateDoc(episodeRef, { likes: newLikes, likedUsers: arrayRemove(userEmail) });
      } else {
        newLikes += 1;
        await updateDoc(episodeRef, { likes: newLikes, likedUsers: arrayUnion(userEmail) });
      }
      fetchAndRenderEpisodes();
    };
    window.deleteEpisode = async (id) => {
  if (!confirm("Are you sure you want to delete this episode?")) return;
  await deleteDoc(doc(db, "episodes", id));
  fetchAndRenderEpisodes();
};

   window.renderEpisodes = (episodes) => {
  const container = document.getElementById("episodesContainer");
  container.innerHTML = "";
  episodes.forEach(data => {
    const isLiked = (data.likedUsers || []).includes(userEmail);
    const commentsHtml = (data.comments || []).map(c => `<div>‚Ä¢ <strong>${c.username}</strong>: ${c.text}</div>`).join("");

    const savedTimeKey = `videoTime_${data.url}`;
    const savedTime = parseFloat(localStorage.getItem(savedTimeKey)) || 0;
    const durationText = savedTime > 0 ? `Continue at ${formatTime(savedTime)}` : '';

    container.innerHTML += `
      <div class="episode-box">
        <h3>${data.title}</h3>
        <video src="${data.url}" muted></video>
        <div class="actions">
  <button onclick="playFull('${data.url}')">‚ñ∂Ô∏è Watch</button>
  ${savedTime > 0 ? `<button onclick="continueWatching('${data.url}')">‚è© Continue Watching (${formatTime(savedTime)})</button>` : ''}
  <button onclick="toggleLike('${data.id}')">${isLiked ? 'üíî Unlike' : '‚ù§Ô∏è Like'} (${data.likes || 0})</button>
  ${isOwner ? `<button onclick="deleteEpisode('${data.id}')">üóëÔ∏è Delete</button>` : ''}
</div>

        <div class="comment-box">
          <input type="text" id="comment-${data.id}" placeholder="Add a comment...">
          <button onclick="addComment('${data.id}')">Comment</button>
          <div class="comments-list">${commentsHtml}</div>
        </div>
      </div>`;
  });
};

    window.logout = () => {
      signOut(auth);
    };

 window.playFull = (url) => {
  const savedTimeKey = `videoTime_${url}`;
  const savedTime = parseFloat(localStorage.getItem(savedTimeKey)) || 0;

  const video = document.createElement("video");
  video.src = url;
  video.controls = true;
  video.autoplay = true;
  video.style.width = "100%";
  video.style.height = "100%";

  // Set saved time when metadata is loaded
  video.addEventListener("loadedmetadata", () => {
    if (savedTime < video.duration) {
      video.currentTime = savedTime;
    }
  });

  const closeButton = document.createElement("button");
  closeButton.textContent = "‚ùå Close";
  closeButton.style.position = "absolute";
  closeButton.style.top = "10px";
  closeButton.style.right = "10px";
  closeButton.style.padding = "0.5rem 1rem";
  closeButton.style.fontSize = "1rem";
  closeButton.style.background = "#e94560";
  closeButton.style.color = "white";
  closeButton.style.border = "none";
  closeButton.style.borderRadius = "5px";
  closeButton.style.cursor = "pointer";
  closeButton.style.zIndex = "10000";

  const wrapper = document.createElement("div");
  wrapper.style.position = "fixed";
  wrapper.style.top = 0;
  wrapper.style.left = 0;
  wrapper.style.width = "100vw";
  wrapper.style.height = "100vh";
  wrapper.style.backgroundColor = "black";
  wrapper.style.zIndex = 9999;
  wrapper.appendChild(video);
  wrapper.appendChild(closeButton);

  closeButton.onclick = () => {
    // Save the current time
    localStorage.setItem(savedTimeKey, video.currentTime);
    
    if (document.fullscreenElement) {
      document.exitFullscreen();
    }
    wrapper.remove();
  };

  wrapper.onclick = (e) => {
    if (e.target === wrapper) {
      closeButton.click();
    }
  };

  document.body.appendChild(wrapper);

  if (wrapper.requestFullscreen) {
    wrapper.requestFullscreen();
  } else if (wrapper.webkitRequestFullscreen) {
    wrapper.webkitRequestFullscreen();
  } else if (wrapper.msRequestFullscreen) {
    wrapper.msRequestFullscreen();
  }
};

window.formatTime = (seconds) => {
  const min = Math.floor(seconds / 60);
  const sec = Math.floor(seconds % 60).toString().padStart(2, '0');
  return `${min}:${sec}`;
};

window.continueWatching = (url) => {
  playFull(url);
};


  </script>
</body>
</html>
